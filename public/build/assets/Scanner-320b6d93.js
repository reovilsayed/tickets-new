import{r as c,j as e,a as q,R as T,B as k}from"./app-51db04e1.js";import{e as X}from"./qr-scanner.min-96809117.js";import{a as G,P as ee,I as se,B as z,F as ne}from"./PhoneNumberInput-ab2c7884.js";import"./index-1377788e.js";function ae({item:s}){const r=c.useMemo(()=>((s==null?void 0:s.newQty)??0)-((s==null?void 0:s.qty)??0),[s==null?void 0:s.newQty,s==null?void 0:s.qty]);return e.jsx(e.Fragment,{children:e.jsxs("tr",{className:"table-info",children:[e.jsx("td",{children:(s==null?void 0:s.display_name)??(s==null?void 0:s.name)}),e.jsxs("td",{children:[s==null?void 0:s.price," €"]}),e.jsx("td",{children:r}),e.jsxs("td",{children:[(s==null?void 0:s.price)*r," €"]})]})})}function le({items:s=[],cartTotal:r=0,discount:l=0}){const j=c.useMemo(()=>r-l,[r,l]);return e.jsxs("div",{className:"h-100 d-flex flex-column justify-content-start",children:[e.jsx("h5",{className:"modal-title text-start mb-2",id:"paymentModalLabel",children:"Cart Information"}),e.jsx("div",{className:"cart-info-items-container",children:e.jsx("div",{className:"card",children:e.jsxs("table",{className:"table mb-0 rounded",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Item"}),e.jsx("th",{children:"Price"}),e.jsx("th",{children:"Quantity"}),e.jsx("th",{children:"Total"})]})}),e.jsx("tbody",{children:s==null?void 0:s.map((u,n)=>u.newQty?e.jsx(ae,{item:u},n):"")})]})})}),e.jsx("div",{className:"card mt-auto",children:e.jsx("table",{className:"table mb-0",children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{children:"Subtotal"}),e.jsxs("td",{children:[r," €"]})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Discount"}),e.jsxs("td",{children:[l," €"]})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Total"}),e.jsxs("td",{children:[j," €"]})]})]})})})]})}const te=({open:s,onClose:r,ticket:l,handleSubmit:j,withdraw:u,setWithdraw:n})=>{const[m,x]=c.useState(!0),[f,S]=c.useState(!1),D=()=>{S(t=>!t)},$=()=>{x(t=>!t)},P=c.useMemo(()=>{var y;var t=0;return(y=l==null?void 0:l.extras)==null||y.map(h=>{(h==null?void 0:h.newQty)>0&&(t+=((h==null?void 0:h.newQty)-h.qty)*h.price)}),t},[l==null?void 0:l.extras]),[d,b]=c.useState({name:"",email:"",phone:"",vatNumber:"",discount:0,paymentMethod:"Cash",withdraw:u}),{data:I}=G(["withdraw_checked"],"https://events.essenciacompany.com/api/withdraw_checked");c.useEffect(()=>{n(I==null?void 0:I.checked)},[I]),c.useEffect(()=>{var t;(t=l==null?void 0:l.order_id)!=null&&t.billing&&b({name:l.order_id.billing.name||"",email:l.order_id.billing.email||"",phone:l.order_id.billing.phone||"",vatNumber:l.order_id.billing.vatNumber||"",discount:0,paymentMethod:"Cash"})},[l]);const w=t=>{const{name:y,value:h}=t.target;b(C=>({...C,[y]:h}))},[F,_]=c.useState(!1);c.useEffect(()=>{const t=document.getElementById("scannerPaymentModal");s?(t.classList.add("show","fade-in"),t.style.display="block"):(t.classList.remove("fade-in"),t.classList.add("fade-out"),setTimeout(()=>{t.style.display="none",t.classList.remove("show","fade-out")},300))},[s]);const M=()=>r(),v=async()=>{var h;_(!0);const t={biling:d,tickets:[],extras:(h=l==null?void 0:l.extras)==null?void 0:h.map(C=>{if(C.newQty>0)return{...C,quantity:C.newQty-C.qty}}),discount:d.discount,paymentMethod:d.paymentMethod,subTotal:P,total:P,sendToMail:f,sendToPhone:m};(await q.post("https://events.essenciacompany.com/api/create-order",t,{headers:{"Content-Type":"application/json","X-Secret-Key":"pos_password"}})).status==200&&(j(),b({name:"",email:"",phone:"",vatNumber:"",discount:0,paymentMethod:"Cash"}),S(!1),x(!1),M()),_(!1)};return e.jsxs(e.Fragment,{children:[s&&e.jsx("div",{className:"payment-modal-backdrop payment-modal-fade-in"}),e.jsx("div",{className:`modal payment-modal ${s?"payment-modal-fade-in":"payment-modal-fade-out"}`,id:"scannerPaymentModal",tabIndex:"-1","aria-labelledby":"paymentModalLabel","aria-hidden":!s,onClick:M,children:e.jsx("div",{className:"modal-dialog modal-center modal-lg",onClick:t=>t.stopPropagation(),children:e.jsxs("div",{className:"modal-content p-0",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title text-center",id:"paymentModalLabel",children:"Place Order"}),e.jsx("button",{type:"button",className:"btn-close","aria-label":"Close",onClick:M})]}),e.jsxs("div",{className:"modal-body row",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("h5",{className:"modal-title text-start mb-2",id:"paymentModalLabel",children:"Payment Information"}),e.jsxs("div",{className:"form-group mb-2",children:[e.jsx("label",{htmlFor:"nameInput",children:"Name"}),e.jsx("input",{id:"nameInput",name:"name",className:"form-control",value:d.name,onChange:w,placeholder:"Enter name"})]}),e.jsxs("div",{className:"form-group mb-2",children:[e.jsxs("label",{htmlFor:"emailInput",children:["Email"," ",d.vatNumber||f?"":"(optional)"]}),e.jsx("input",{id:"emailInput",className:"form-control",name:"email",value:d.email,onChange:w,placeholder:"Enter email"})]}),m?e.jsx(ee,{value:d.phone,onChange:t=>b(y=>({...y,phone:"+"+t}))}):"",e.jsxs("div",{className:"form-group mb-2",children:[e.jsx("label",{htmlFor:"vatInput",children:"VAT Number (optional)"}),e.jsx("input",{id:"vatInput",className:"form-control",name:"vatNumber",value:d.vatNumber,onChange:w,placeholder:"Enter VAT number"})]}),e.jsxs("div",{className:"form-group row mb-4",children:[e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{htmlFor:"discountInput",children:"Payment Method"}),e.jsxs("select",{class:"form-select","aria-label":"Default select example",onChange:t=>b(y=>({...y,paymentMethod:t.target.value})),children:[e.jsx("option",{value:"Cash",selected:!0,children:"Cash"}),e.jsx("option",{value:"Card",children:"Card"})]})]}),e.jsxs("div",{className:"col-md-8",children:[e.jsx("label",{htmlFor:"discountInput",children:"Discount"}),e.jsx("input",{id:"discountInput",type:"number",className:"form-control",name:"discount",value:d.discount>0?d.discount:"",onChange:w,placeholder:"Enter discount"})]})]}),e.jsxs("div",{className:"form-check",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",value:"",id:"flexCheckDefault",checked:u,onChange:()=>n(!u)}),e.jsx("label",{className:"form-check-label",for:"flexCheckDefault",children:"Withdraw"})]}),e.jsxs("div",{class:"form-check",children:[e.jsx("input",{class:"form-check-input",type:"checkbox",value:m,checked:m,onChange:$,id:"sendToPhoneCheck"}),e.jsx("label",{class:"form-check-label",htmlFor:"sendToPhoneCheck",children:"Send to phone"})]}),e.jsxs("div",{class:"form-check",children:[e.jsx("input",{class:"form-check-input",type:"checkbox",value:f,checked:f,onChange:D,id:"sendToMailCheck"}),e.jsx("label",{class:"form-check-label",htmlFor:"sendToMailCheck",children:"Send to mail"})]})]}),e.jsx("div",{className:"col-md-6",children:e.jsx(le,{items:l==null?void 0:l.extras,cartTotal:P,discount:d.discount})})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:M,children:"Close"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:v,disabled:!d.name||(d.vatNumber?!(d.email||d.phone):!1)||F,children:F?"Processing...":"Proceed"})]})]})})})]})},oe=({extra:s,index:r,handleExtraChange:l})=>{const[j,u]=c.useState(0);parseInt((s==null?void 0:s.newQty)??0)||parseInt((s==null?void 0:s.qty)??0);const n=parseFloat((s==null?void 0:s.price)??0).toFixed(2),m=f=>{const S=parseInt(f.target.value)||0;u(S)},x=()=>{j>0&&j<=s.qty-s.used&&(l(s,j),u(0))};return e.jsx("div",{className:"card",children:e.jsxs("div",{className:"card-body text-start",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("p",{className:"h6",children:[(s==null?void 0:s.display_name)??(s==null?void 0:s.name)," X ",(s==null?void 0:s.qty)-(s==null?void 0:s.used)]}),e.jsxs("h6",{children:["€"," ",(n*parseInt(s!=null&&s.newQty?(s==null?void 0:s.newQty)-(s==null?void 0:s.qty):0)).toFixed(2)]})]}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("label",{htmlFor:"",children:["Withdraw (Available: ",(s==null?void 0:s.qty)-(s==null?void 0:s.used),")"]}),e.jsxs("div",{className:"form-inline d-flex gap-2",children:[e.jsx("input",{type:"number",min:1,max:(s==null?void 0:s.qty)-(s==null?void 0:s.used),value:j,onChange:m,className:"form-control"}),e.jsx("button",{className:"btn btn-sm btn-dark",onClick:x,children:e.jsx("i",{className:"fa fa-check"})})]})]})]})},r)},he=()=>{var V,W;const s=T.useRef(null),[r,l]=c.useState(null),[j,u]=c.useState(!1),[n,m]=c.useState(null),[x,f]=c.useState(""),[S,D]=c.useState(!1),[$,P]=c.useState(!1),[d,b]=c.useState(!1);c.useEffect(()=>{if(s.current&&!r){const a=new X(s.current,o=>{w(o)},{highlightScanRegion:!0,highlightCodeOutline:!0});l(a)}return()=>{r&&(r.stop(),r.destroy(),l(null))}},[s.current,r]);const I=()=>{r?(u(!0),D(!0),r.start()):console.error("Scanner is not initialized yet")},w=async a=>{if(a!=null&&a.data)try{const o=await q.post("https://events.essenciacompany.com/api/tickets/get",{ticket:a==null?void 0:a.data});m(o.data)}catch(o){k("Error scanning ticket",o)}},F=a=>{a.key==="Enter"&&_()},_=async()=>{if(x){P(!1),u(!1);try{const a=await q.post("https://events.essenciacompany.com/api/tickets/get",{ticket:x});m(a.data),f("")}catch(a){k("Error scanning ticket",a)}finally{setIsProcessing(!1)}}},M=(a,o)=>{const p=parseInt(a==null?void 0:a.used)??0;if(o=parseInt(o),o>a.qty-(a==null?void 0:a.used))return;a={...a,used:o+p};var N=n.extras.map(Q=>Q.id===a.id?a:Q);let i=n;i.extras=N,m(i),console.log(n),B()},{data:v,isError:t,isLoading:y,isSuccess:h,refetch:C}=G(["scanner-extras",n],`https://events.essenciacompany.com/api/event-extras/${n==null?void 0:n.event_id}`),[A,K]=c.useState(!1),[g,L]=c.useState(null),[R,O]=c.useState(1),Y=()=>{var N;if(!A){K(!0);return}const a={...g,qty:0,newQty:R};var o=!0,p=(N=n==null?void 0:n.extras)==null?void 0:N.map(i=>(console.log(i),i.id===a.id?(o=!1,{...i,newQty:parseInt(a.newQty)+parseInt((i==null?void 0:i.newQty)??(i==null?void 0:i.qty)??0)}):i));o&&(p=[...p,a]),m(i=>({...i,extras:[...p]})),K(!1),L(null),O(1)},[H,E]=c.useState(!1),B=async()=>{if(E(!0),(await q.post("https://events.essenciacompany.com/api/update-ticket",{ticket:n,can_withdraw:d},{headers:{"Content-Type":"application/json","X-Secret-Key":"pos_password"}})).status==200&&(m(null),u(!1),b(!1),k("Ticket updated successfully!!"),r)){r.stop();const o=new X(s.current,p=>{w(p)},{highlightScanRegion:!0,highlightCodeOutline:!0});l(o),o.start()}E(!1)},J=async()=>{var o,p;E(!0);const a=await q.post("https://events.essenciacompany.com/api/tickets/toggle-active",{ticket:n==null?void 0:n.id},{headers:{"Content-Type":"application/json","X-Secret-Key":"pos_password"}});a.status==200&&(m(N=>{var i,Q;return{...N,active:(Q=(i=a==null?void 0:a.data)==null?void 0:i.ticket)==null?void 0:Q.active}}),k(`Ticket ${((p=(o=a==null?void 0:a.data)==null?void 0:o.ticket)==null?void 0:p.active)===1?"activated":"de-activated"} successfully!!`)),E(!1)},[Z,U]=c.useState(!1);return e.jsxs("section",{className:"scanner-page",children:[n?e.jsxs("div",{className:"ticket-info",children:[e.jsx("h3",{children:"Ticket Information"}),e.jsxs("div",{className:"ticket-details",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Owner:"})," ",n==null?void 0:n.owner.name]}),(n==null?void 0:n.owner.email)&&e.jsxs("p",{children:[e.jsx("strong",{children:"Email:"})," ",n==null?void 0:n.owner.email]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Event:"})," ",n==null?void 0:n.event_name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Ticket:"})," ",n==null?void 0:n.product_name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Price:"})," €",n==null?void 0:n.price]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Status:"})," ",(n==null?void 0:n.status)===0?"Not Used":"Used"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Dates:"})," ",n==null?void 0:n.dates.join(", ")]}),e.jsx("p",{children:e.jsxs("div",{className:"active-toggle-container",children:[e.jsx("strong",{children:"Active"}),e.jsx("div",{class:"form-check form-switch",children:e.jsx("input",{class:`form-check-input ${(n==null?void 0:n.active)===1?"bg-success":"bg-danger"}`,type:"checkbox",onClick:J,checked:(n==null?void 0:n.active)===1})})]})})]}),((V=n==null?void 0:n.extras)==null?void 0:V.length)>0?e.jsxs("div",{className:"extras",children:[e.jsx("h4",{children:"Extras"}),n==null?void 0:n.extras.map((a,o)=>e.jsx(oe,{extra:a,index:o,handleExtraChange:M}))]}):null,A&&e.jsx("div",{className:"modal-body row",children:e.jsxs("div",{className:"col-md-12",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"extraSelect",children:"Select Extra"}),e.jsxs("select",{id:"extraSelect",className:"form-control mt-2",value:(g==null?void 0:g.display_name)||"",onChange:a=>{var p;const o=(p=v==null?void 0:v.data)==null?void 0:p.find(N=>N.display_name===a.target.value);L(o||null)},children:[e.jsx("option",{value:"",children:"None"}),(W=v==null?void 0:v.data)==null?void 0:W.map((a,o)=>e.jsx("option",{value:a==null?void 0:a.display_name,children:a==null?void 0:a.display_name},o))]})]}),g&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"form-group mt-3 d-flex flex-column justify-content-center align-items-center",children:[e.jsx("label",{htmlFor:"quantity",children:"Quantity"}),e.jsxs(se,{className:"w-50",children:[e.jsx(z,{variant:"outline-secondary",onClick:()=>O(a=>a-1>0?a-1:a),children:"-"}),e.jsx(ne.Control,{"aria-label":"Example text with two button addons",className:"text-center",readOnly:!0,value:R}),e.jsx(z,{variant:"outline-danger",onClick:()=>O(a=>a+1),children:"+"})]})]}),e.jsxs("label",{htmlFor:"price",children:["Price",e.jsx("br",{}),(g==null?void 0:g.price)*R,"€"]})]})]})}),e.jsx("span",{className:"d-flex justify-content-center align-items-center mt-2",children:e.jsx("button",{type:"button",class:"btn btn-info text-light w-100 py-1",onClick:Y,children:"Add extra"})}),e.jsx("span",{className:"d-flex justify-content-center align-items-center mt-2",children:e.jsx("button",{type:"button",class:"btn btn-success text-light w-100 py-1",onClick:()=>U(!0),children:H?"Processing...":"Save Changes"})})]}):j?"":e.jsxs("div",{className:"d-flex flex-column align-items-center gap-3",children:[e.jsxs("div",{className:"qr-box flex-column",onClick:I,children:[e.jsx("img",{className:"qr-image",src:"/assets/qr-code.png",alt:"QR Code"}),e.jsx("h3",{children:"start scanning"})]}),e.jsx("h3",{children:"or"}),e.jsx("input",{className:"qr-box flex-column",type:"text",onChange:a=>f(a.target.value),onKeyDown:F,placeholder:"Manually enter ticket code"})]}),!n&&e.jsxs("div",{children:[e.jsx("div",{id:"viewfinder",className:"qr-box",style:S?{}:{display:"none"},children:e.jsx("video",{ref:s,children:"Your browser does not support video playback."})}),e.jsx("div",{id:"manual-input",className:"form-group",style:$?{}:{display:"none"},children:e.jsx("input",{type:"text",name:"manual",className:"form-control",id:"manual",value:x,onChange:a=>f(a.target.value),onKeyDown:F,placeholder:"Enter ticket code manually"})})]}),e.jsx(te,{open:Z,onClose:()=>U(!1),ticket:n,handleSubmit:B,withdraw:d,setWithdraw:b})]})};export{he as default};
